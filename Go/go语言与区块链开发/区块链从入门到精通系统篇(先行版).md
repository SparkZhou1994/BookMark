# 比特币诞生背景
## 为何适合作为金融货币
### 比特币如何解决拜占庭将军问题
- 数字签名
- 最长链，因为不知道世界上有多少人在用比特币，每次以最长的链为准绳
- POW机制，作恶成本高
# 比特币介绍
## 比特币交易简单介绍
- 交易创建
- 通过网络传播
- 交易验证（签名）
- 验证结果通过网络传播（通过算力，10分钟记一次帐）
- 交易写入账本
## 与传统记账方式的对比
### 区块是什么
记录多条交易的一页账单
### 区块链是什么
按照时间顺序将多个账单装订在一起形成的账本
## 比特币和区块链关系
- 区块链是由比特币的底层支撑系统
- 区块链是从比特币抽离出来的概念，由比特币产生
## 比特币（区块链）使用
### 哈希算法
### 密码学
#### 非对称加密应用
##### 比特币地址
通过私钥使用椭圆曲线乘法这个单向加密函数产生一个公钥。有了公钥，使用一个单向加密哈希函数产生比特币地址。
公钥到比特币地址的过程
- 公钥 通过 双哈希 HASH160（SHA256 RIPEMD160）得到 公钥哈希（20字节）
- 公钥哈希通过 Base58check编码（前缀版本为0x00）得到 比特币地址
### P2P网络（用于 广播交易， 同步账本）
### 默克尔树 (用于快速验证交易)
Merkle Tree 称为 Hash Tree，存储hash值的一棵平衡二叉树
## 比特币相关参数
- 区块大小上限 1M
- 总计 2100 万枚， 2140年挖完
- 每10分钟一个区块，通过难度值调整实现
- 21万个 区块后奖励减半，大约四年，目前奖励12.5（2018年）
- 1btc = 10^8 聪明 satoshi
## 比特币区块结构
### 区块结构
|字节|字段|说明|
|:-:|:-:|:-:|
|4|区块大小||
|80|区块头||
|1-9|交易计数器|该区块包含的交易数量|
|不定|交易|交易信息，使用原生的交易信息格式，并且交易在数据流中的位置必须与Merkle树的叶子节点顺序一致|
区块大小目前严格限制在1MB内（除了区块大小）
### 区块头(Block Header)  
|字节|字段|说明|
|:-:|:-:|:-:|
|4|版本|区块版本号，表示本区块遵守的验证规则|
|32|父区块头哈希值|使用SHA256|
|32|Merkle根|该区块中交易的Merkle树根的哈希值，使用SHA256|
|4|时间戳|该区块产生的近似时间，精准到秒的UNIX时间戳，必须严格大于前11个区块时间的中值，同时全节点也会拒绝那些超出自己2个小时时间戳的区块|
|4|难度目标|该区块工作量证明算法的难度目标，已经使用特定算法编码|
|4|Nonce|为了找到满足难度目标所设定的随机数，为了解决32位随机数载算力飞升的情况下不够用的问题，规定时间戳和coinbase交易信息均可更改，以此拓展nonce的位数|
区块不存储hash值，节点接受区块后独立计算并存储在本地
### 区块体(Transactions)
- coinbase交易：第一条交易，挖矿奖励矿工
- 普通转账交易：每笔交易包括付款方、收款方、付款金额、手续费等等(后面详细讲解)
### 创世块
整个链条的第一块。hash值表示块，高度也能表示块。但同一个高度可能有多个块，产生分叉，下一个块来选择哪个最长，哪个继续链接。
## 比特币交易详细流程
- 创建交易，广播交易
- 临近节点接受交易，校验交易
- 广播该交易，并将交易放入代确认池中
- 校验结束后，等待下一个记账周期开始，所有节点竞争记账权，挖矿
- 某个节点计算成功后，向全网公布计算结果
- 其他节点校验通过后，算出结果的节点进行记账，获取比特币
- 广播自己的账本，全网各个节点同步最新账本
## 比特币交易
### 未消费输出(UTXO)
UTXO: unspent transaction output，是比特币交易中最小的支付单元，不可分割，每一个UTXO必须一次性消耗完，然后生成新的UTXO，存放在比特币网络的UTXO池中。
当一个用户接收比特币时，金额被当作UTXO记录到区块链里。这样，一个用户的比特币会被当作UTXO分散到数百个交易和数百个区块中。实际上，并不存在存储比特币地址或账户余额的地点，只有被所有者锁住的、分散的UTXO。
新的交易从UTXO集中消耗(支付)一个或多个输出。
### 交易
#### 交易结构
|大小|字段|描述|
|:-:|:-:|:-:|
|4字节|版本|明确这笔交易参考的规则|
|1-9字节|输入数量|被包含的输入的数量|
|不定|输入|一个或多个交易输入|
|1-9字节|输出数量|被包含的输出的数量|
|不定|输出|一个或多个交易输出|
|4字节|时钟时间|一个UNIX时间戳或区块号|
#### 多种交易形式
- 普通交易，一个输入一个输出，10个UTXO，8个给对方，2个给自己或者手续费
- 多对一，慈善机构收款后消费
- 一对多，公司老板发工资
#### TxInput
指明交易发起人可支付资金的来源，包含：
- 引用utxo所在交易的ID
- 所消费utxo在output中的索引(因为一个交易会有多个output，需要索引值来确定)
- 解锁脚本(签名)
#### TxOutput
包含资金接收方的相关信息，包含
- 接收金额
- 锁定脚本(收款方地址)
#### 代码查看交易(json)
### UTXO消费和产生过程
Alice向Bob支付8个BTC，由于Alice只有3BTC和6BTC的UTXO，所以需要创建一个1BTC的UTXO来找零给自己。这笔交易消耗了两个UTXO，并产生了两个新的UTXO，并由比特币系统将他们添加到比特币UTXO池中。
交易前，会遍历UTXO集，查找Alice合理的UTXO，作为输入。消费完的UTXO被销毁，新生成的UTXO被创建。
### 解决双花问题(Double-Spending)
时间戳+utxo
- 已经确认的交易时(utxo)
- 尚未确认交易时(时间戳最早的一笔)
- 被两个节点同时挖出，比特币链条会分叉
- 被两个节点同时挖出(立即化为矿工连追两个区块，变成最长链)，解决办法，等6个区块后再交付产品
### 解决拜占庭将军问题




















































